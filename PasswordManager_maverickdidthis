import java.io.*;
import java.util.ArrayList;
import java.util.Scanner;

public class PasswordManager {
    public static void main(String[] args) {
        Scanner input = new Scanner(System.in);

        // login screen
        ArrayList<String> loginUser = new ArrayList<>();
        ArrayList<String> loginPass = new ArrayList<>();

        // sites and accounts
        ArrayList<String> site = new ArrayList<>();
        ArrayList<ArrayList<String>> siteUsers = new ArrayList<>();
        ArrayList<ArrayList<String>> sitePasswords = new ArrayList<>();

        String db = "database.txt";
        loadDB(db, site, siteUsers, sitePasswords, loginUser, loginPass);

        // first-time signing up
        if (loginUser.isEmpty()) {
            System.out.println("First-time Setup");
            System.out.print("Enter username: ");
            loginUser.add(input.nextLine());
            System.out.print("Enter password: ");
            String pass = input.nextLine();
            System.out.print("Confirm password: ");
            String confirm = input.nextLine();

            if (pass.equals(confirm)) {
                loginPass.add(pass);
                System.out.println("Setup finished!");
                saveData(db, site, siteUsers, sitePasswords, loginUser, loginPass);
            } else {
                System.out.println("Passwords do not match. Restart program.");
                return;
            }
        } else { // already registered
            boolean loggedIn = false;
            while (!loggedIn) {
                System.out.print("Username: ");
                String u = input.nextLine();
                System.out.print("Password: ");
                String p = input.nextLine();

                if (u.equals(loginUser.get(0)) && p.equals(loginPass.get(0))) {
                    System.out.println("Successfully logged in.");
                    loggedIn = true;
                } else {
                    System.out.println("Username or Password incorrect, try again!");
                }
            }
        }

        // main screen
        while (true) {
            System.out.println("\n---Password Manager---");
            System.out.println("1. Add Credentials");
            System.out.println("2. View Credentials");
            System.out.println("3. Delete Credentials");
            System.out.println("4. Exit");
            System.out.print("Choice: ");
            String choice = input.nextLine();

            if (choice.equals("1")) { // add
                System.out.print("Enter Website: ");
                String newSite = input.nextLine();
                System.out.print("Enter Username/Email: ");
                String newUser = input.nextLine();
                System.out.print("Enter Password: ");
                String newPass = input.nextLine();

                int index = site.indexOf(newSite);
                if (index != -1) { // existing site
                    siteUsers.get(index).add(newUser);
                    sitePasswords.get(index).add(newPass);
                } else { // new site
                    site.add(newSite);
                    ArrayList<String> usersList = new ArrayList<>();
                    ArrayList<String> passList = new ArrayList<>();
                    usersList.add(newUser);
                    passList.add(newPass);
                    siteUsers.add(usersList);
                    sitePasswords.add(passList);
                }
                saveData(db, site, siteUsers, sitePasswords, loginUser, loginPass);
                System.out.println("Credentials saved.");

            } else if (choice.equals("2")) { // view
                if (site.isEmpty()) {
                    System.out.println("No credentials saved.");
                } else {
                    System.out.println("--- Websites ---");
                    for (int i = 0; i < site.size(); i++) {
                        System.out.println((i + 1) + ". " + site.get(i));
                    }
                    System.out.print("Select a website: ");
                    int sIndex = Integer.parseInt(input.nextLine()) - 1;

                    if (sIndex < 0 || sIndex >= site.size()) {
                        System.out.println("Invalid choice.");
                        continue;
                    }

                    System.out.println("--- Accounts for " + site.get(sIndex) + " ---");
                    ArrayList<String> usersList = siteUsers.get(sIndex);
                    ArrayList<String> passList = sitePasswords.get(sIndex);
                    for (int i = 0; i < usersList.size(); i++) {
                        System.out.println((i + 1) + ". Username: " + usersList.get(i) + " | Password: " + passList.get(i));
                    }
                }

            } else if (choice.equals("3")) { // delete
                if (site.isEmpty()) {
                    System.out.println("No credentials to delete.");
                } else {
                    System.out.println("--- Websites ---");
                    for (int i = 0; i < site.size(); i++) {
                        System.out.println((i + 1) + ". " + site.get(i));
                    }
                    System.out.print("Select a website: ");
                    int sIndex = Integer.parseInt(input.nextLine()) - 1;
                    if (sIndex < 0 || sIndex >= site.size()) {
                        System.out.println("Invalid choice.");
                        continue;
                    }

                    ArrayList<String> usersList = siteUsers.get(sIndex);
                    ArrayList<String> passList = sitePasswords.get(sIndex);
                    System.out.println("--- Accounts ---");
                    for (int i = 0; i < usersList.size(); i++) {
                        System.out.println((i + 1) + ". " + usersList.get(i));
                    }
                    System.out.print("Select account number to delete: ");
                    int aIndex = Integer.parseInt(input.nextLine()) - 1;

                    if (aIndex < 0 || aIndex >= usersList.size()) {
                        System.out.println("Invalid choice.");
                    } else {
                        usersList.remove(aIndex);
                        passList.remove(aIndex);
                        if (usersList.isEmpty()) { // remove site if no accounts left
                            site.remove(sIndex);
                            siteUsers.remove(sIndex);
                            sitePasswords.remove(sIndex);
                        }
                        saveData(db, site, siteUsers, sitePasswords, loginUser, loginPass);
                        System.out.println("Deleted successfully.");
                    }
                }

            } else if (choice.equals("4")) {
                System.out.println("Exiting...");
                break;
            } else {
                System.out.println("Invalid choice.");
            }
        }
    }

    // Save to file
    public static void saveData(String db, ArrayList<String> site, ArrayList<ArrayList<String>> siteUsers,
                                ArrayList<ArrayList<String>> sitePasswords, ArrayList<String> loginUser,
                                ArrayList<String> loginPass) {
        try (PrintWriter pw = new PrintWriter(new FileWriter(db))) {
            if (!loginUser.isEmpty() && !loginPass.isEmpty()) {
                pw.println("LOGIN|" + loginUser.get(0) + "|" + loginPass.get(0));
            }
            for (int i = 0; i < site.size(); i++) {
                ArrayList<String> usersList = siteUsers.get(i);
                ArrayList<String> passList = sitePasswords.get(i);
                for (int j = 0; j < usersList.size(); j++) {
                    pw.println(site.get(i) + "|" + usersList.get(j) + "|" + passList.get(j));
                }
            }
        } catch (Exception e) {
            System.out.println("Error saving database.");
        }
    }

    // load from file
    public static void loadDB(String db, ArrayList<String> site, ArrayList<ArrayList<String>> siteUsers,
                              ArrayList<ArrayList<String>> sitePasswords, ArrayList<String> loginUser,
                              ArrayList<String> loginPass) {
        try {
            File file = new File(db);
            if (!file.exists()) return;

            try (BufferedReader br = new BufferedReader(new FileReader(file))) {
                String line;
                while ((line = br.readLine()) != null) {
                    String[] parts = line.split("\\|");
                    if (parts[0].equals("LOGIN")) {
                        loginUser.add(parts[1]);
                        loginPass.add(parts[2]);
                    } else if (parts.length == 3) {
                        String s = parts[0], u = parts[1], p = parts[2];
                        int index = site.indexOf(s);
                        if (index != -1) { // existing site
                            siteUsers.get(index).add(u);
                            sitePasswords.get(index).add(p);
                        } else { // new site
                            site.add(s);
                            ArrayList<String> uList = new ArrayList<>();
                            ArrayList<String> pList = new ArrayList<>();
                            uList.add(u);
                            pList.add(p);
                            siteUsers.add(uList);
                            sitePasswords.add(pList);
                        }
                    }
                }
            }
        } catch (Exception e) {
            System.out.println("Error loading database.");
        }
    }
}
